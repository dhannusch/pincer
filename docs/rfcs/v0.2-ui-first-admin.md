# RFC: v0.2 UI-First Admin, Optional Admin CLI, and In-Worker Secret Management

- Status: Draft
- Date: 2026-02-19
- Target: v0.2.0
- Scope: `apps/pincer-worker`, `apps/pincer-admin`, docs

## 1. Summary

v0.2.0 should make the Worker Admin UI the primary interface for all day-to-day admin tasks.

Desired outcome:
- Users can manage adapters, proposals, runtime credentials, and secrets from the UI.
- `pincer-admin` remains available as an optional power-user/automation interface.
- `pincer-agent` remains the runtime interface for OpenClaw.
- The project stays slim: one worker, two CLI packages.

This RFC proposes a UI-first control plane implemented inside the existing Worker, with secure session auth and a write-only secret UX.

## 2. Problem Statement

Current state is secure in some paths but creates product friction:
- Admin auth is currently a static header passphrase (`x-pincer-admin-passphrase`), which is operationally awkward and replayable if captured.
- Most admin operations are CLI-first, while product expectation is browser-first.
- Cloudflare control-plane credentials (Wrangler/API token) are extremely powerful; if leaked, app-layer protections are bypassed.
- Cloudflare Worker secrets are easy for setup but not naturally UI-managed from inside the Worker runtime.

User-facing problem:
- Admin UX feels split between terminal and UI, instead of one coherent admin product.

## 3. Goals

- Make `/admin` the primary admin surface for normal operations.
- Support complete admin operations from UI:
  - proposals review/approve/reject
  - adapter enable/disable
  - runtime credential rotation
  - pairing code generation
  - secret value updates (write-only UX)
  - health/doctor/metrics/audit views
- Keep `pincer-admin` optional and consistent with the same API model.
- Keep default quickstart secure-enough without requiring manual Cloudflare Access setup.
- Provide clear optional hardening guidance (Access, stricter policies, etc.).

## 4. Non-Goals (v0.2)

- Full enterprise IAM/RBAC matrix.
- Multi-tenant team org model.
- External secret manager integrations (Vault/SM/KMS plugin system).
- Replacing `pincer-agent` runtime call flow.

## 5. Design Principles

- UI-first product: no mandatory CLI handoff for normal admin tasks.
- Control-plane minimization: reduce routine dependence on Wrangler/API tokens.
- Write-only secrets: show status and metadata, never plaintext retrieval.
- Backward-compatible migration where possible.
- Preserve small footprint and deploy simplicity.

## 6. Proposed v0.2 Architecture

### 6.1 Admin Surface

- Serve Admin UI from the existing Worker at `/admin`.
- Continue using `/v1/admin/*` routes for admin API operations.
- `pincer-admin` becomes an optional client to these APIs (plus setup/bootstrap helpers).

### 6.2 Auth Model (UI + API)

Replace static-header-only admin auth as the primary path.

Primary auth flow:
- `POST /v1/admin/session/login` with admin credentials.
- Worker returns short-lived, HttpOnly, Secure cookie session.
- State-changing routes require CSRF token + same-site cookie.
- Session TTL + idle timeout + periodic session rotation.
- Login rate limits and lockout/backoff on repeated failures.

Bootstrap flow (first admin setup):
- Use one-time bootstrap token secret (`PINCER_BOOTSTRAP_TOKEN`) set during setup/deploy.
- `GET/POST /admin/bootstrap` allowed only if no admin account exists.
- Token consumed/invalidated after bootstrap.

Compatibility:
- Legacy passphrase header auth can remain behind a feature flag during migration.

### 6.3 Secrets UX and Storage

To allow UI-based secret management without storing broad Cloudflare API credentials in-browser:

Introduce a Pincer-managed encrypted secret store in KV.

- Keep a root encryption key as Worker secret: `PINCER_VAULT_KEK`.
- Store adapter secret values encrypted in KV:
  - key: `vault:secret:<binding>`
  - value: `{ keyId, nonce, ciphertext, updatedAt, updatedBy }`
- UI endpoints:
  - `GET /v1/admin/secrets` (metadata only: binding, present, updatedAt)
  - `PUT /v1/admin/secrets/:binding` (set/replace value)
  - `DELETE /v1/admin/secrets/:binding` (remove value)

Write-only contract:
- Secret values are accepted on write, never returned on read.

Runtime resolution order:
1. Pincer KV vault secret (decrypt at request time)
2. Cloudflare Worker secret fallback (legacy compatibility)
3. Missing => fail closed

### 6.4 API and CLI Roles

- UI calls authenticated admin endpoints directly.
- Optional `pincer-admin` commands call the same endpoints for automation and scripts.
- Keep setup/deploy bootstrap tasks in CLI for now (Wrangler workflow), but no daily admin dependence.

## 7. Security Analysis

### 7.1 Replay and Current Passphrase Limitation

Current passphrase header auth is static and replayable if captured.

v0.2 improves this by moving to session + CSRF + expiry:
- Captured request payload/header alone is insufficient without valid session cookie.
- Session theft is still a risk but has bounded TTL and revocation options.

### 7.2 Threat Scenarios

1. Runtime credentials leaked from agent host:
- Expected result: attacker can perform runtime actions/proposals, but cannot access admin session-protected routes.

2. Admin browser session token stolen:
- Mitigation: short TTL, same-site cookies, CSRF checks, session rotation, logout-all capability.

3. Wrangler/API token leaked:
- Still high-severity control-plane compromise.
- Mitigation: scope minimization, token hygiene, optional hardened deployment mode.

4. Worker read access compromise:
- Attacker may decrypt vault secrets via runtime if code path abused.
- Mitigation: strict route auth, input validation, audit alerts, hardening profile.

## 8. Product UX (Target)

### 8.1 Quickstart UX

- Run setup once (CLI or guided script) to deploy worker.
- Open `/admin` and bootstrap admin account.
- Manage everything day-to-day from UI.

### 8.2 Day-2 Operations in UI

- Review pending proposals with manifest diff context.
- Approve/reject proposals.
- Enable/disable adapters.
- Set/rotate secret values (write-only).
- Generate pairing code.
- Rotate runtime credentials.
- View health/doctor/metrics and audit history.

### 8.3 Optional CLI UX

- `pincer-admin` remains available for:
  - automation scripts
  - CI/CD workflows
  - incident response from terminal

## 9. Hardening Profiles

Default profile (quickstart):
- Session-based admin auth
- CSRF + rate limits
- Encrypted secret store
- Audit events

Optional hardened profile:
- Place `/admin` behind Cloudflare Access
- Restrict admin routes by IP/device policy
- Disable legacy passphrase mode
- Tighter session TTL and forced re-auth for sensitive actions

## 10. Migration Plan

### 10.1 Backward Compatibility

- Keep existing admin routes and passphrase checks available under compatibility flag in v0.2.
- Introduce new session-based auth path in parallel.

### 10.2 Secret Migration

- Existing Worker secrets remain supported as fallback.
- UI can progressively set values into KV vault.
- Once all bindings are migrated, operators can remove legacy Worker secret bindings for adapter keys.

### 10.3 Deprecation

- Mark static passphrase header mode as deprecated in v0.2 docs.
- Target removal or disabled-by-default in v0.3.

## 11. Implementation Milestones

### M1: Auth + Admin Shell

- Add `/admin` app shell.
- Add bootstrap + session auth endpoints.
- Add CSRF/session middleware for admin APIs.
- Add login rate limits and audit events for auth actions.

Exit criteria:
- Admin can log in/out and access protected admin routes from browser.

### M2: Full Admin Operations in UI

- Proposals/adapters/audit/doctor pages.
- Enable/disable/apply/reject actions.
- Pairing code generation and runtime credential rotation.
- Secret metadata page + set/delete operations.

Exit criteria:
- Normal admin workflows no longer require CLI.

### M3: Secret Vault + Migration + Hardening Docs

- Encrypt/decrypt KV secret vault with KEK worker secret.
- Runtime fallback resolution (vault then env).
- Migration UX and status indicators.
- Hardened-mode docs and optional Access bootstrap command.

Exit criteria:
- UI manages adapter secrets end-to-end with write-only semantics.

## 12. Open Questions

- Should v0.2 support single-admin only, or basic multi-admin users?
- Should sensitive actions require step-up auth (password re-entry)?
- What should be the default session TTL and idle timeout?
- Is KV sufficient for all expected secret/value counts, or do we need D1 later for richer metadata?

## 13. Recommendation

Proceed with this UI-first architecture for v0.2.

This path gives:
- materially better product UX,
- clear default security posture,
- optional hardening for stricter environments,
- and minimal architecture sprawl (still one worker + two CLIs).
